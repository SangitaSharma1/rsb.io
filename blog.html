<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/pure-min.css">
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/fontello.css">
<link href='http://fonts.googleapis.com/css?family=Noto+Sans:400,700' rel='stylesheet' type='text/css'>
<title>Ryan Scott Brown</title>
</head>
<body>
<div class="pure-g container">
  <div class="translucent-background"></div>
  <div class="pure-u-1-5 padding-right-5">
    <div class="table-of-contents">
      <h1>Table of Contents</h1>

      <p>generated by <a href="http://ryansb.github.io/mdtocs/">mtdocs</a></p>

      <ul>
        <li><a href="#the-guide-to-chef-hudl-and-delicious-ops">The Guide to Chef, Hudl, and Delicious Ops</a>

        <ul>
          <li><a href="#building-an-awesome-cookbook-checklist">Building an Awesome Cookbook Checklist</a></li>
          <li><a href="#foolish-consistency-is-the-hobgoblin-of-little-minds">Foolish Consistency is the Hobgoblin of Little Minds</a></li>
          <li><a href="#words-of-the-day">Words of the Day</a>

          <ul>
            <li><a href="#idempotentcy">Idempotentcy</a></li>
            <li><a href="#composability">Composability</a></li>
          </ul></li>
          <li><a href="#naming-conventions">Naming conventions</a>

          <ul>
            <li><a href="#examples">Examples</a></li>
          </ul></li>
          <li><a href="#separation-of-concerns">Separation of Concerns</a></li>
          <li><a href="#library-vs-application-cookbooks">Library vs. Application Cookbooks</a>

          <ul>
            <li><a href="#library-cookbook">Library Cookbook</a></li>
            <li><a href="#application-cookbook">Application Cookbook</a></li>
          </ul></li>
          <li><a href="#anatomy-of-a-cookbook">Anatomy of a Cookbook</a>

          <ul>
            <li><a href="#cookbookattributes">cookbook/attributes</a></li>
            <li><a href="#cookbookrecipes">cookbook/recipes</a></li>
          </ul></li>
          <li><a href="#future-reference">Future Reference</a></li>
          <li><a href="#breaking-up-another-monolith">Breaking Up Another Monolith</a>

          <ul>
            <li><a href="#artifact-lwrp-resource">Artifact LWRP Resource</a></li>
            <li><a href="#knife-spork">Knife-Spork</a></li>
          </ul></li>
          <li><a href="#faq">FAQ</a></li>
          <li><a href="#wtf-is-this-doc">WTF is This Doc?</a></li>
          <li><a href="#conventions-within-this-document">Conventions within this document</a></li>
        </ul></li>
      </ul>

    </div>
  </div>
  <div class="pure-u-3-5 faint-left-border">
    <div class="blogpost">
      <h1>The Guide to Chef, Hudl, and Delicious Ops</h1>

      <p>This guide is a living document about:</p>

      <ol>
        <li>What we've learned from our experience with chef.</li>
        <li>Tools we like in the chef community.</li>
        <li>Workflows for testing, using, and writing great cookbooks.</li>
      </ol>

      <h2>Building an Awesome Cookbook Checklist</h2>

      <ol>
        <li>The default behavior should make sense with no attributes set. Just
        inclusion in a run list should be enough to get some sane behavior. The
        <code>default.rb</code> is the main() for your cookbook, it should make sense.</li>
        <li>Minimize external dependencies</li>
        <li>Tag releases if you make breaking changes, make sure metadata.rb is
        updated as well.</li>
        <li>Test much as possible (see hudl_cuke cookbook)</li>
        <li>Express dependencies in metadata.rb</li>
      </ol>

      <h2>Foolish Consistency is the Hobgoblin of Little Minds</h2>

      <p>Like in a real kitchen, chef cookbooks are written once and read/tweaked many
      times. Favor readability, even if it requires more work when writing the code.</p>

      <p><strong>Important:</strong> know when to be inconsistent. Use your judgement, look at
      examples, ask someone else.</p>

      <p>Good reasons to break rules:</p>

      <ol>
        <li>When applying the guideline would cause the cookbook to <strong>make less sense</strong></li>
        <li>Compatibility</li>
        <li>Consistency with surrounding code.</li>
        <li>Code in question predates the guidelines (this may be time to
        bring it up to spec though)</li>
      </ol>

      <h2>Words of the Day</h2>

      <h3>Idempotentcy</h3>

      <p>All actions/resources should have guard conditions. Your custom filesystem LWRP
      should check that the filesystem is not already formatted. Anytime chef runs a
      shell command, it should have a <code>not_if</code> guard condition to prevent that
      command from breaking things in the future.</p>

      <p>Related: Avoid <code>line_in_file</code> for changing files, and use templates instead.
      These are idempotent by default.</p>

      <h3>Composability</h3>

      <p><a href="https://github.com/thlorenz/doctoc">Composability</a> is the ability to untangle dependencies. All dependencies
      should be explicitly expressed with either <code>include</code> (in recipes) or <code>require</code>
      (in metadata), or <strong>very obviously</strong> in documentation where dependencies are
      hard to express with those directives.</p>

      <p>This is important for these reasons:</p>

      <ol>
        <li>Testing. Being able to isolate a cookbook is critical for testing it
        properly.</li>
        <li>Portability. We intend to reuse as much as we can both to save time and
        to reduce the number of places we need to make changes to fix errors.</li>
        <li>Unforseen use cases. Combining cookbooks shouldn't require a deep
        understanding of all the dependencies, since cookbooks can express and
        manage those themselves. It should be a 2-step process.
        <strong>1)</strong> understand the purpose of the cookbooks you want to combine.
        <strong>2)</strong> combine them.</li>
      </ol>

      <h2>Naming conventions</h2>

      <p>Community cookbooks get first dibs on names. Period. All our own cookbooks will
      have the prefix hudl_cookbookname. Typically, the Hudl-specific cookbook's
      suffix will be the same as the community cookbook it wraps.</p>

      <h3>Examples</h3>

      <p>Community Cookbooks
      * mongo
      * nginx
      * aws</p>

      <p>Hudl Cookbooks
      * hudl_mongo
      * hudl_nginx
      * hudl_ebs</p>

      <p>You may be thinking "but one of these things is not like the other!" and you're
      right. This is a case where breaking style is alright because really the
      hudl_ebs cookbook <strong>only</strong> deals with EBS volumes, not with every AWS resource.
      Calling the cookbook hudl_aws would be a misnomer. Remember the Hobgoblins.</p>

      <h2>Separation of Concerns</h2>

      <p>Let's return to the hudl_ebs example. Naming it hudl_aws would be exceptionally
      general. Names that are too general may encourage people to expand that
      cookbook when it doesn't make sense to do so. It'd be easy to say "oh, I'll
      just add Route53 and Elastic IP support to hudl_aws because they're AWS things
      too." That would be unrelated compared to the existing functionality, though
      the name doesn't indicate as such. If a feature is unrelated to the core
      function of a cookbook, consider making a new cookbook. There's a reason we
      don't have one enormous "hudl_servers" cookbook.</p>

      <h2>Library vs. Application Cookbooks</h2>

      <h3>Library Cookbook</h3>

      <p>A library cookbook is usually a community cookbook, but not always. The real
      requirement is that the cookbook be generic, and have options that are easy to
      tweak through attributes.</p>

      <p>You can feel free to write custom library cookbooks, but when you start
      including app-specific (Hudl-specific) information, consider separating out the
      reusable parts into an application cookbook. A way to tell if something it too
      specific is to ask "would I Open-Source this?"</p>

      <h3>Application Cookbook</h3>

      <p>Contains corporate data. Usually overrides things in a library cookbook while
      adding in site-specific resources/attributes.</p>

      <p>Application cookbooks should be as small as is feasible, and should express
      their own dependencies through <code>include</code> or <code>require</code>. The idea here is for an
      application cookbook to be a facet of a server. For example, hudl_serverdensity
      is only the Hudl-specific code to add monitoring to an application. It has an
      <code>include</code> for the community serverdensity cookbook, which it uses. This
      represents the entirety of work necessary to add monitoring to a server.</p>

      <p>Application cookbooks <strong>delegate</strong> responsibility to library cookbooks for the
      heavy lifting. They should primarily handle data, or compose multiple library
      cookbooks into a coherent, larger feature.</p>

      <h2>Anatomy of a Cookbook</h2>

      <h3>cookbook/attributes</h3>

      <p>Make sure to namespace your attributes, usually with the cookbook name, so they
      don't clobber namespaces for anyone else. If you find that you must clobber
      namespace or modify attributes of other cookbooks <strong>explicitly document</strong> that
      the cookbook does so or risk debugging hell later on.</p>

      <p>Attributes are usually all lower case with _ separated words, just like
      cookbooks. The top-level namespace should be the same as the cookbook name, for
      example "hudl_ebs" or "elasticsearch".</p>

      <h3>cookbook/recipes</h3>

      <p>An individual recipe can represent a single task, or a series of tasks which
      are order-sensitive.</p>

      <p>Recipes are intended to be composable. For the hudl_serverdensity cookbook, we
      see this in the different recipe names. The <code>default.rb</code> simply includes the
      <code>install</code> and <code>server-monitor</code> recipes, the most common use case for the
      cookbook. There is a separate recipe for adding serverdensity plugins, which
      can be included in addition to the default recipe.</p>

      <h2>Future Reference</h2>

      <p>This section is for practices/tools that we do not yet (and may not ever) use,
      so we can keep track of what is out there, and not duplicate research.</p>

      <h2>Breaking Up Another Monolith</h2>

      <p>Our cookbooks are all in the same repo. We can pretty easily break them out
      while still maintaining their history. See <a href="https://github.com/thlorenz/doctoc">this gist</a> for details.
      Effectively, we'd use git subtree to extract the history of each directory and
      then push that to its own git repository.</p>

      <p>Once we've got them all in their own repositories we'll be able to manage
      releases correctly with tags etc and can then move towards implementing
      Berkshelf or a similar tool to separate cookbooks by environment.</p>

      <h3>Artifact LWRP Resource</h3>

      <p>The <a href="https://github.com/thlorenz/doctoc">artifact-cookbook</a> allows us to use a resource provider to manage
      multiple tarballs of different versions of a piece of software, and on servers
      just manage a single symlink to the current version of that artifact.</p>

      <h3>Knife-Spork</h3>

      <p>The <a href="https://github.com/thlorenz/doctoc">knife-spork</a> is a knife plugin to manage the versioning of cookbooks,
      such as checking used version numbers, and for freezing a cookbook for
      versioning. It also can promote cookbooks between environments (which we don't
      do at all, currently) so that different versions of cookbooks can be used on
      stage and prod.</p>

      <h2>FAQ</h2>

      <p>Q: I thought of a new thing to do in chef! I'll just get hacking!</p>

      <p>A: Whoa there, cowboy. First check to see if there's a community cookbook that
      does what you need, odds are there is. You can use that as a library cookbook
      and then build your own wrapper if you find yourself needing to add
      functionality. <strong>Building on top of something is much, much faster</strong></p>

      <p>Q: I found this great community cookbook that I want to fork because it doesn't
      do (some awesome thing).</p>

      <p>A: No. You don't actually want to do that because community cookbooks are:</p>

      <ol>
        <li>great because we get improvements the community
        makes <strong>for free</strong></li>
        <li>versioned, so we can stick to a specific version
        if we decide the "improvements" are bad, no forking needed</li>
        <li>easy to wrap with our own Hudl-specific cookbook</li>
      </ol>

      <h2>WTF is This Doc?</h2>

      <p>This is a best practices document for Chef.</p>

      <p>This is a summary of some best practices from <a href="https://github.com/thlorenz/doctoc">Chef Antipatterns</a>,
      <a href="http://www.prashantrajan.com/posts/2013/06/leveling-up-chef-best-practices/">Chef Best Practices</a>, and the lessons we've learned ourselves.</p>

      <h2>Conventions within this document</h2>

      <p>Within this document conventions are:</p>

      <ol>
        <li>Limit line with to 79 characters when possible</li>
        <li>Use <code>#</code>, <code>##</code>, etc for headers instead of <code>=====</code> syntax</li>
        <li>Use <code>*</code> for italics and <code>**</code> for bold</li>
        <li>Use <code>1.</code> for every item in a numbered list. This makes reordering items
        easier, and the markdown parser renders the correct numbers at
        compile time.</li>
        <li>If you update headers or subheaders, re-generate the table of contents with
        <a href="https://github.com/thlorenz/doctoc">doctoc</a> using the command <code>doctoc GUIDE.md</code></li>
      </ol>
    </div>
  </div>
</div>
<div class="pure-u-1-2 attribution" xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/" about="http://subtlepatterns.com/">
  <span property="dct:title">Subtle Patterns</span> (<a rel="cc:attributionURL" property="cc:attributionName" href="http://subtlepatterns.com">Subtle Patterns</a>) / <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0</a>
</div>
</body>
</html>
